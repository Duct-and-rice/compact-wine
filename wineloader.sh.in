#!/bin/ksh -e

! (($DEBUG)) || set -x
! (($WINELOADERNOEXEC)) || exec $WINE "$@"

case $0 in
*/*) prefix=`cd "${0%/*}"/.. && pwd` ;;
*  ) prefix=`cd           .. && pwd` ;;
esac

set -a
PATH=$prefix/libexec:$prefix/bin:/usr/bin:/bin
WINE=$prefix/libexec/wine
WINEDEBUG=${WINEDEBUG-fixme-all}
set +a

case $1 in
''|--help|--version)
    exec $WINE "$@"
    ;;
esac

check_timestamp()
{
    _install_inf()
    {
        for f in "$prefix"/share/wine/inf/*.inf
        {
            test -f "$f" || continue
            $WINE 'C:\windows\system32\rundll32.exe' \
              setupapi,InstallHinfSection DefaultInstall 128 \
              '\\?\'unix"$f"
        }
    }

    read timestamp_ctime 2>/dev/null <"${WINEPREFIX-$HOME/.wine}"/.update-timestamp || :
    case ${timestamp_ctime:+set} in
    set)
        ((`stat -f inf_ctime=%c -t %s "$prefix"/share/wine/wine.inf`))
        (($timestamp_ctime < $inf_ctime)) || return 0
    esac

    _install_inf
}
check_timestamp

exec $WINE "$@"
