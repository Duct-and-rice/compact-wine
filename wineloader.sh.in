#!/bin/ksh
#
# WINELOADER  Copyright (C) 2014  mattintosh4, https://github.com/mattintosh4
#

run()
{
    case ${WINELOADERNOEXEC+:} in
    :) printf '\e[1;30m%s\e[m\n' "$*" >&2;;
    *) printf '\e[1;32m%s\e[m\n' "$*" >&2;;
    esac
    exec wine "$@"
}



# GENERAL ----------------------------------------------------------------------

case $0 in
*/*) PREF=`cd "${0%/*}"/.. && pwd` ;;
*  ) PREF=`cd           .. && pwd` ;;
esac

PATH=$PREF/libexec:/usr/bin:/bin:/usr/sbin:/sbin

# RECURSIVE EXECUTION
${WINELOADERNOEXEC+run "$@"}

# CONDITIONAL SKIPPING
case $1 in ''|--help|--version) exec wine "$@" ;; esac

# ENVIRONMENT VARIABLE
set -a
case $LANG          in '') LANG=ja_JP.UTF-8       ;; esac
case $WINEPREFIX    in '') WINEPREFIX=$HOME/.wine ;; esac
case ${WINEDEBUG+:} in '') WINEDEBUG=fixme-all    ;; esac
set +a

# WINEPREFIX CREATION
load_custom_inf()
{
    set -- "$PREF"/share/wine/inf/*.inf
    test -f "$1" || return 0
    for f
    {
        # keep current process
        (
            run 'C:\windows\system32\rundll32.exe' \
                setupapi,InstallHinfSection DefaultInstall 128 \
                '\\?\'unix"$f"
        )
    }
}
check_timestamp()
{
    read 2>/dev/null <"$WINEPREFIX"/.update-timestamp || :
    case $REPLY in
    '')
        wine 'C:\windows\system32\wineboot.exe' --init
        ;;
    *)
        set -- `stat -f %c -t %s "$PREF"/share/wine/wine.inf`
        test "$1" -gt "$REPLY" || return 0
        ;;
    esac
    load_custom_inf
}
check_timestamp



# EXECUTION --------------------------------------------------------------------

run "$@"
